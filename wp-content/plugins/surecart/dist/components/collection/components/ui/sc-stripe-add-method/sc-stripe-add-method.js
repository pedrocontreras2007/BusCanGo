import{h}from"@stencil/core";import{loadStripe}from"@stripe/stripe-js/pure";import{__}from"@wordpress/i18n";import apiFetch from"../../../functions/fetch";import{addQueryArgs}from"@wordpress/url";export class ScStripeAddMethod{constructor(){this.liveMode=!0,this.customerId=void 0,this.successUrl=void 0,this.loading=void 0,this.loaded=void 0,this.error=void 0,this.paymentIntent=void 0}componentWillLoad(){this.createPaymentIntent()}async handlePaymentIntentCreate(){var e,t,r,o,i,s,a,d,n,l,c,u,h,p,m,y,f,b;if(!(null===(r=null===(t=null===(e=this.paymentIntent)||void 0===e?void 0:e.processor_data)||void 0===t?void 0:t.stripe)||void 0===r?void 0:r.publishable_key)||!(null===(s=null===(i=null===(o=this.paymentIntent)||void 0===o?void 0:o.processor_data)||void 0===i?void 0:i.stripe)||void 0===s?void 0:s.account_id))return;if(!this.stripe)try{this.stripe=await loadStripe(null===(n=null===(d=null===(a=this.paymentIntent)||void 0===a?void 0:a.processor_data)||void 0===d?void 0:d.stripe)||void 0===n?void 0:n.publishable_key,{stripeAccount:null===(u=null===(c=null===(l=this.paymentIntent)||void 0===l?void 0:l.processor_data)||void 0===c?void 0:c.stripe)||void 0===u?void 0:u.account_id})}catch(e){return void(this.error=(null==e?void 0:e.message)||__("Stripe could not be loaded","surecart"))}if(!(null===(m=null===(p=null===(h=this.paymentIntent)||void 0===h?void 0:h.processor_data)||void 0===p?void 0:p.stripe)||void 0===m?void 0:m.client_secret)||!this.container)return void console.warn("do not have client secret or container");const v=getComputedStyle(document.body);this.elements=this.stripe.elements({clientSecret:null===(b=null===(f=null===(y=this.paymentIntent)||void 0===y?void 0:y.processor_data)||void 0===f?void 0:f.stripe)||void 0===b?void 0:b.client_secret,appearance:{variables:{colorPrimary:v.getPropertyValue("--sc-color-primary-500"),colorText:v.getPropertyValue("--sc-input-label-color"),borderRadius:v.getPropertyValue("--sc-input-border-radius-medium"),colorBackground:v.getPropertyValue("--sc-input-background-color"),fontSizeBase:v.getPropertyValue("--sc-input-font-size-medium")},rules:{".Input":{border:v.getPropertyValue("--sc-input-border")},".Input::placeholder":{color:v.getPropertyValue("--sc-input-placeholder-color")}}}}),this.elements.create("payment",{wallets:{applePay:"never",googlePay:"never"}}).mount(".sc-payment-element-container"),this.element=this.elements.getElement("payment"),this.element.on("ready",(()=>this.loaded=!0))}async createPaymentIntent(){try{this.loading=!0,this.error="",this.paymentIntent=await apiFetch({method:"POST",path:"surecart/v1/payment_intents",data:{processor_type:"stripe",live_mode:this.liveMode,customer_id:this.customerId,refresh_status:!0}})}catch(e){this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart")}finally{this.loading=!1}}async handleSubmit(e){var t;e.preventDefault(),this.loading=!0;try{const e=await this.stripe.confirmSetup({elements:this.elements,confirmParams:{return_url:addQueryArgs(this.successUrl,{payment_intent:null===(t=this.paymentIntent)||void 0===t?void 0:t.id})},redirect:"always"});if(null==e?void 0:e.error)throw this.error=e.error.message,e.error}catch(e){console.error(e),this.error=(null==e?void 0:e.message)||__("Something went wrong","surecart"),this.loading=!1}}render(){return h("sc-form",{key:"8e845052545f9fe890711a03267286cbc0bfc45d",onScFormSubmit:e=>this.handleSubmit(e)},this.error&&h("sc-alert",{key:"e98d82890d5a8bf65f1f36c880dbcf4cdf881a74",open:!!this.error,type:"danger"},h("span",{key:"3e91bb0231f05ce5df6f590162e0f2b13e95a318",slot:"title"},__("Error","surecart")),this.error),h("div",{key:"f3072f45957b70cbb5a05d253fb6f15c0f445c0a",class:"loader",hidden:this.loaded},h("div",{key:"d37417fb74b5e0d7e653ff45a0bae9d0dde9bcfe",class:"loader__row"},h("div",{key:"5d5a5a71f9d849f52f0ba2e5c9ea5bc5e7183d48",style:{width:"50%"}},h("sc-skeleton",{key:"eb17b431d7dc4a61d3dead6a6a0afda73f214dc5",style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",{key:"410b5c297aea688b0874aef8cef4bcb7db7d9cd4"})),h("div",{key:"4ddeac240da4d5411a4c3cda49ccc37f548f38d7",style:{flex:"1"}},h("sc-skeleton",{key:"3bbe0609af43c46680d6f4ba4780eb1903c79929",style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",{key:"1da596b67774b6987948fa6fa37999eb73dba13c"})),h("div",{key:"d16cf7741490fa9f3f081deab2266ba2d5d9507a",style:{flex:"1"}},h("sc-skeleton",{key:"0edd09577b9d150640af19084429bd190c6d3fdf",style:{width:"50%",marginBottom:"0.5em"}}),h("sc-skeleton",{key:"ad194c7e8f8b0888cc114e36beae735b818b0a1f"}))),h("div",{key:"20181d75ead0645a45407f501698d70443f5bda3",class:"loader__details"},h("sc-skeleton",{key:"b19a21abd53d58b41f17f360b61fa0a64c19f588",style:{height:"1rem"}}),h("sc-skeleton",{key:"f0a741c05ebd0e7a56bdf94c78eec1402b8a8895",style:{height:"1rem",width:"30%"}}))),h("div",{key:"5266da6be0be8e3c5e4d4e629929500d9953094f",hidden:!this.loaded,class:"sc-payment-element-container",ref:e=>this.container=e}),h("sc-button",{key:"dd0e5116560a0e82368f560efdf0bb08853147ae",type:"primary",submit:!0,full:!0,loading:this.loading},__("Save Payment Method","surecart")))}static get is(){return"sc-stripe-add-method"}static get originalStyleUrls(){return{$:["sc-stripe-add-method.scss"]}}static get styleUrls(){return{$:["sc-stripe-add-method.css"]}}static get properties(){return{liveMode:{type:"boolean",mutable:!1,complexType:{original:"boolean",resolved:"boolean",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"live-mode",reflect:!1,defaultValue:"true"},customerId:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"customer-id",reflect:!1},successUrl:{type:"string",mutable:!1,complexType:{original:"string",resolved:"string",references:{}},required:!1,optional:!1,docs:{tags:[],text:""},attribute:"success-url",reflect:!1}}}static get states(){return{loading:{},loaded:{},error:{},paymentIntent:{}}}static get watchers(){return[{propName:"paymentIntent",methodName:"handlePaymentIntentCreate"}]}}